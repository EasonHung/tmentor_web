{"ast":null,"code":"import { getClassroomId } from \"../../../api_handler/classroom_api_handler\";\nimport { getUserId } from \"../../../cookie_handler/user_cookie_handler\";\nconst iceServers = {\n  'iceServers': [\n  // {'url': 'stun:stun.l.google.com:19302'},\n  {\n    \"url\": \"turn:relay1.expressturn.com:3478\",\n    \"username\": \"efC2OT8W129D2ID63H\",\n    \"credential\": \"6ZeChztFE4cxEmgg\"\n  }]\n};\n// const videoConstraints = {\n//     audio: false, \n//     video: true\n// }\n\nlet pc = null;\nexport async function onRTCOffer(setRemoteStream, localStream, message, classroomWs) {\n  pc = new RTCPeerConnection(iceServers);\n  pc.ontrack = event => {\n    setRemoteStream(event.streams[0]);\n  };\n  pc.onicecandidate = async _ref => {\n    let {\n      candidate\n    } = _ref;\n    if (candidate != null) {\n      classroomWs.send(JSON.stringify({\n        \"cmd\": \"candidate\",\n        \"senderId\": getUserId(),\n        \"applicationType\": \"app\",\n        \"recieverId\": message.senderId,\n        \"classroomId\": await getClassroomId(),\n        \"message\": {\n          'sdpMLineIndex': candidate.sdpMLineIndex,\n          'sdpMid': candidate.sdpMid,\n          'candidate': candidate.candidate\n        }\n      }));\n    }\n  };\n  try {\n    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));\n  } catch (err) {\n    console.error(err);\n  }\n  await pc.setRemoteDescription(new RTCSessionDescription(message.message));\n  await pc.setLocalDescription(await pc.createAnswer());\n  classroomWs.send(JSON.stringify({\n    \"cmd\": \"answer\",\n    \"senderId\": getUserId(),\n    \"applicationType\": \"web\",\n    \"recieverId\": message.senderId,\n    \"classroomId\": await getClassroomId(),\n    \"message\": {\n      'sdp': pc.localDescription.sdp,\n      'type': pc.localDescription.type\n    }\n  }));\n}\nexport async function onICECandidate(message) {\n  if (pc !== null) {\n    pc.addIceCandidate(new RTCIceCandidate(message.message));\n  }\n}\nexport async function startLocalStream(setLocalStream) {\n  const stream = await navigator.mediaDevices.getUserMedia({\n    audio: false,\n    video: true\n  });\n  setLocalStream(stream);\n  return stream;\n}\nexport function stopLocalStream(setLocalStream) {\n  setLocalStream({});\n}\nexport function closePeerConnection() {\n  if (pc) {\n    pc.close();\n    pc = null;\n  }\n}\nexport async function startPeerConnection(classroomWs, teacherClassroomInfo, setRemoteStream, setLocalStream, message) {\n  if (message.senderId !== getUserId()) {\n    return;\n  }\n  pc = new RTCPeerConnection(iceServers);\n  pc.ontrack = event => {\n    setRemoteStream(event.streams[0]);\n  };\n  pc.onicecandidate = async _ref2 => {\n    let {\n      candidate\n    } = _ref2;\n    if (candidate != null) {\n      classroomWs.send(JSON.stringify({\n        \"cmd\": \"candidate\",\n        \"senderId\": getUserId(),\n        \"applicationType\": \"web\",\n        \"recieverId\": teacherClassroomInfo.teacherId,\n        \"classroomId\": teacherClassroomInfo.classroomId,\n        \"message\": {\n          'sdpMLineIndex': candidate.sdpMLineIndex,\n          'sdpMid': candidate.sdpMid,\n          'candidate': candidate.candidate\n        }\n      }));\n    }\n  };\n  const localStream = await startLocalStream(setLocalStream);\n  try {\n    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));\n  } catch (err) {\n    console.error(err);\n  }\n  await pc.setLocalDescription(await pc.createOffer());\n  classroomWs.send(JSON.stringify({\n    \"cmd\": \"offer\",\n    \"senderId\": getUserId(),\n    \"applicationType\": \"web\",\n    \"recieverId\": teacherClassroomInfo.teacherId,\n    \"classroomId\": teacherClassroomInfo.classroomId,\n    \"message\": {\n      'sdp': pc.localDescription.sdp,\n      'type': pc.localDescription.type\n    }\n  }));\n}\nexport function onAnswer(message) {\n  if (pc) {\n    pc.setRemoteDescription(new RTCSessionDescription(message.message));\n  }\n}","map":{"version":3,"names":["getClassroomId","getUserId","iceServers","pc","onRTCOffer","setRemoteStream","localStream","message","classroomWs","RTCPeerConnection","ontrack","event","streams","onicecandidate","_ref","candidate","send","JSON","stringify","senderId","sdpMLineIndex","sdpMid","getTracks","forEach","track","addTrack","err","console","error","setRemoteDescription","RTCSessionDescription","setLocalDescription","createAnswer","localDescription","sdp","type","onICECandidate","addIceCandidate","RTCIceCandidate","startLocalStream","setLocalStream","stream","navigator","mediaDevices","getUserMedia","audio","video","stopLocalStream","closePeerConnection","close","startPeerConnection","teacherClassroomInfo","_ref2","teacherId","classroomId","createOffer","onAnswer"],"sources":["/Users/hongyixun/Desktop/tmentor/tmentor_web/src/pages/classroom/service/webRTC_service.js"],"sourcesContent":["import { getClassroomId } from \"../../../api_handler/classroom_api_handler\";\nimport { getUserId } from \"../../../cookie_handler/user_cookie_handler\";\n\nconst iceServers = {\n    'iceServers': [\n        // {'url': 'stun:stun.l.google.com:19302'},\n        {\n        \"url\": \"turn:relay1.expressturn.com:3478\",\n        \"username\": \"efC2OT8W129D2ID63H\",\n        \"credential\": \"6ZeChztFE4cxEmgg\",\n        },\n    ]\n};\n// const videoConstraints = {\n//     audio: false, \n//     video: true\n// }\n\nlet pc = null\n\n\nexport async function onRTCOffer(setRemoteStream, localStream, message, classroomWs) {\n    pc = new RTCPeerConnection(iceServers);\n\n    pc.ontrack = (event) => {\n        setRemoteStream(event.streams[0])\n    };\n\n    pc.onicecandidate = async ({candidate}) => {\n        if(candidate != null) {\n            classroomWs.send(\n                JSON.stringify({\n                    \"cmd\": \"candidate\",\n                    \"senderId\": getUserId(),\n                    \"applicationType\": \"app\",\n                    \"recieverId\": message.senderId,\n                    \"classroomId\": await getClassroomId(),\n                    \"message\": {\n                      'sdpMLineIndex': candidate.sdpMLineIndex,\n                      'sdpMid': candidate.sdpMid,\n                      'candidate': candidate.candidate,\n                    }\n                })\n            )\n        }\n    }\n\n    try {\n        localStream.getTracks().forEach( (track) =>\n          pc.addTrack(track, localStream)\n        )\n    } catch (err) {\n        console.error(err);\n    }\n\n    await pc.setRemoteDescription(new RTCSessionDescription(message.message));\n\n    await pc.setLocalDescription(await pc.createAnswer());\n\n    classroomWs.send(\n        JSON.stringify({\n            \"cmd\": \"answer\",\n            \"senderId\": getUserId(),\n            \"applicationType\": \"web\",\n            \"recieverId\": message.senderId,\n            \"classroomId\": await getClassroomId(),\n            \"message\": {\n              'sdp': pc.localDescription.sdp,\n              'type': pc.localDescription.type,\n            }\n        })\n    )\n}\n\nexport async function onICECandidate(message) {\n    if(pc !== null) {\n        pc.addIceCandidate(new RTCIceCandidate(message.message));\n    }\n}\n\nexport async function startLocalStream(setLocalStream) {\n    const stream = await navigator.mediaDevices.getUserMedia({audio: false, video: true})\n    setLocalStream(stream)\n    return stream\n}\n\nexport function stopLocalStream(setLocalStream) {\n    setLocalStream({})\n}\n\nexport function closePeerConnection() {\n    if(pc) {\n        pc.close()\n        pc = null\n    }\n}\n\nexport async function startPeerConnection(classroomWs, teacherClassroomInfo, setRemoteStream, setLocalStream, message) {\n    if(message.senderId !== getUserId() ) {\n        return\n    }\n\n    pc = new RTCPeerConnection(iceServers);\n\n    pc.ontrack = (event) => {\n        setRemoteStream(event.streams[0])\n    };\n\n    pc.onicecandidate = async ({candidate}) => {\n        if(candidate != null) {\n            classroomWs.send(\n                JSON.stringify({\n                    \"cmd\": \"candidate\",\n                    \"senderId\": getUserId(),\n                    \"applicationType\": \"web\",\n                    \"recieverId\": teacherClassroomInfo.teacherId,\n                    \"classroomId\": teacherClassroomInfo.classroomId,\n                    \"message\": {\n                      'sdpMLineIndex': candidate.sdpMLineIndex,\n                      'sdpMid': candidate.sdpMid,\n                      'candidate': candidate.candidate,\n                    }\n                })\n            )\n        }\n    }\n\n    const localStream = await startLocalStream(setLocalStream)\n\n    try {\n        localStream.getTracks().forEach( (track) =>\n          pc.addTrack(track, localStream)\n        )\n    } catch (err) {\n        console.error(err);\n    }\n\n    await pc.setLocalDescription(await pc.createOffer());\n\n    classroomWs.send(\n        JSON.stringify({\n            \"cmd\": \"offer\",\n            \"senderId\": getUserId(),\n            \"applicationType\": \"web\",\n            \"recieverId\": teacherClassroomInfo.teacherId,\n            \"classroomId\": teacherClassroomInfo.classroomId,\n            \"message\": {\n              'sdp': pc.localDescription.sdp,\n              'type': pc.localDescription.type,\n            }\n        })\n    )\n}\n\nexport function onAnswer(message) {\n    if(pc) {\n        pc.setRemoteDescription(new RTCSessionDescription(message.message));\n    }\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}